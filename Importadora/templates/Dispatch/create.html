{% extends 'Adm/admin.html' %}

{% load widget_tweaks %}

{% block body %}
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 class="m-0 text-danger text-bold">{{ title }}</h1>
                    </div><!-- /.col -->
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="{% url 'adm' %}">Home</a></li>
                            <li class="breadcrumb-item active">Dashboard v3</li>
                        </ol>
                    </div><!-- /.col -->
                </div><!-- /.row -->
            </div><!-- /.container-fluid -->
        </div>

        <!-- Main content -->
        <form method="post" enctype="multipart/form-data" id="form_id">
            <div class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="card card-default">
                            <div class="card-header">
                                <h3 class="card-title">
                                    {% if action == 'add' %}
                                        <i class="fas fa-plus-circle"></i>
                                    {% else %}
                                        <i class="fas fa-edit"></i>
                                    {% endif %}
                                    {{ title2 }}
                                </h3>
                            </div>
                            <!-- /.card-header -->
                            <div class="card-body">
                                <div class="container">
                                    {% csrf_token %}
                                    <div class="text-left text-bold">
                                        {{ form.rut.label }}
                                    </div>
                                    <div class="input-group mb-2">
                                        {{ form.rut | add_class:'form-control' | attr:'placeholder: Ingrese Un Rut' }}
                                    </div>
                                    <div class="text-left text-bold">
                                        {{ form.first_name.label }}
                                    </div>
                                    <div class="input-group mb-2">
                                        {{ form.first_name | add_class:'form-control' | attr:'placeholder: Ingrese Un Primer Nombre' }}
                                    </div>
                                    <div class="text-left text-bold">
                                        {{ form.second_name.label }}
                                    </div>
                                    <div class="input-group mb-2">
                                        {{ form.second_name | add_class:'form-control' | attr:'placeholder: Ingrese Un Segundo Nombre' }}
                                    </div>
                                    <div class="text-left text-bold">
                                        {{ form.pather_last_name.label }}
                                    </div>
                                    <div class="input-group mb-2">
                                        {{ form.pather_last_name | add_class:'form-control' | attr:'placeholder: Ingrese Un Apellido Paterno' }}
                                    </div>
                                    <div class="text-left text-bold">
                                        {{ form.mother_last_name.label }}
                                    </div>
                                    <div class="input-group mb-2">
                                        {{ form.mother_last_name | add_class:'form-control' | attr:'placeholder: Ingrese Un Apellido Materno' }}
                                    </div>
                                    <div class="text-left text-bold">
                                        {{ form.phone.label }}
                                    </div>
                                    <div class="input-group mb-2">
                                        {{ form.phone | add_class:'form-control' | attr:'placeholder: Ingrese Un Celular' }}
                                    </div>
                                    <div class="text-left text-bold">
                                        {{ form.email.label }}
                                    </div>
                                    <div class="input-group mb-2">
                                        {{ form.email | add_class:'form-control' | attr:'placeholder: Ingrese Un Correo Electronico' }}
                                    </div>
                                    <div class="text-left text-bold">
                                        {{ form.image.label }}
                                    </div>
                                    {{ form.image | add_class:'form-control' }}
                                </div>
                                <br>
                                <div class="card-footer">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-audio-description"></i> {{ button }}
                                    </button>
                                    <a href="{{ listadoDespacho }}" type="submit" class="btn btn-success">
                                        <i class="fas fa-audio-description"></i> {{ button2 }}
                                    </a>
                                </div>
                            </div>
                        </div>
                        <script type="application/javascript">
                            $("#form_id").on("submit", function (e) {
                                e.preventDefault();

                                var rut = $("#id_rut").val();

                                console.log(rut);

                                var rutvalido = checkRut(rut);

                                if (!rutvalido) {
                                    var errors = 'El Rut Ingresado No Es Valido';
                                    {% for field in form %}
                                        {% for error in field.errors %}
                                            errors += '{{ error }}\n';
                                        {% endfor %}
                                    {% endfor %}
                                    {% for error in form.non_field_errors %}
                                        errors += '{{ error }}\n';
                                    {% endfor %}
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Oops...',
                                        text: errors
                                    });
                                } else {
                                    $("#form_id").submit();
                                }
                            });

                            //codigo para validar rut
                            function checkRut(rut) {
                                // Despejar Puntos
                                console.log(rut)
                                var valor = rut.replace(/[-.\s]/g, '');
                                {#valor = valor.replace(/-/g, '');#}

                                // Aislar Cuerpo y Dígito Verificador
                                var cuerpo = valor.slice(0, -1);
                                var dv = valor.slice(-1).toUpperCase();

                                // Formatear RUN
                                rut = cuerpo + "-" + dv;

                                // Si no cumple con el mínimo ej. (n.nnn.nnn)
                                if (cuerpo.length < 7) {
                                    {#rut.setCustomValidity("RUT Incompleto");#}
                                    return false;
                                }

                                // Calcular Dígito Verificador
                                var suma = 0;
                                var multiplo = 2;

                                // Para cada dígito del Cuerpo
                                for (var i = 1; i <= cuerpo.length; i++) {
                                    // Obtener su Producto con el Múltiplo Correspondiente
                                    var index = multiplo * valor.charAt(cuerpo.length - i);

                                    // Sumar al Contador General
                                    suma = suma + index;

                                    // Consolidar Múltiplo dentro del rango [2,7]
                                    if (multiplo < 7) {
                                        multiplo = multiplo + 1;
                                    } else {
                                        multiplo = 2;
                                    }
                                }

                                // Calcular Dígito Verificador en base al Módulo 11
                                var dvEsperado = 11 - (suma % 11);

                                // Casos Especiales (0 y K)

                                if (dv === "K") {
                                    dv = 10;
                                }
                                if (dv == 0) {
                                    dv = 11;
                                }

                                console.log(dvEsperado)
                                console.log(dv)

                                // Validar que el Cuerpo coincide con su Dígito Verificador
                                if (dvEsperado != dv) {
                                    {#rut.setCustomValidity("RUT Inválido");#}
                                    return false;
                                }

                                // Si todo sale bien, eliminar errores (decretar que es válido)
                                {#rut.setCustomValidity("");#}
                                return true;
                            }
                        </script>
                    </div>
                </div>
            </div>
        </form>
    </div>
{% endblock %}